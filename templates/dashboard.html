{% extends "base.html" %}

{% block title %}AI Trading Bot Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .trade-log {
        max-height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .status-online { background-color: #28a745; }
    .status-offline { background-color: #dc3545; }
    .status-learning { background-color: #ffc107; }
    
    .prediction-box {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .signal-buy { background: linear-gradient(45deg, #4CAF50, #45a049); }
    .signal-sell { background: linear-gradient(45deg, #f44336, #da190b); }
    .signal-hold { background: linear-gradient(45deg, #ff9800, #f57c00); }
    
    .trade-item {
        padding: 10px;
        border-left: 4px solid #007bff;
        margin-bottom: 10px;
        background: white;
        border-radius: 5px;
    }
    
    .trade-profit { border-left-color: #28a745; }
    .trade-loss { border-left-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-robot"></i> AI Trading Bot Dashboard</h1>
                    <p class="text-muted">Intelligent trading system with machine learning</p>
                </div>
                <div class="text-right">
                    <div class="mb-2">
                        <span class="status-indicator" id="botStatus"></span>
                        <span id="statusText">Checking connection...</span>
                    </div>
                    <small class="text-muted">Last update: <span id="lastUpdate">--</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stats-value" id="totalTrades">--</div>
                        <div>Total Trades</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stats-value" id="winRate">--%</div>
                        <div>Win Rate</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stats-value" id="dailyProfit">$--</div>
                        <div>Daily Profit</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stats-value" id="activeUsers">--</div>
                        <div>Active Bots</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Status and Prediction -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-brain"></i> AI Prediction Engine</h5>
                <div id="predictionBox" class="prediction-box signal-hold">
                    <h3 id="currentSignal">ANALYZING...</h3>
                    <p class="mb-0">Confidence: <span id="confidence">--%</span></p>
                    <small>Neural Network Analysis</small>
                </div>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <strong id="buyProb">--%</strong><br>
                            <small class="text-success">Buy Probability</small>
                        </div>
                        <div class="col-4">
                            <strong id="holdProb">--%</strong><br>
                            <small class="text-warning">Hold Probability</small>
                        </div>
                        <div class="col-4">
                            <strong id="sellProb">--%</strong><br>
                            <small class="text-danger">Sell Probability</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-graduation-cap"></i> AI Learning Progress</h5>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="learningProgress" style="width: 0%">0%</div>
                </div>
                <div class="row text-center">
                    <div class="col-4">
                        <strong id="dataPoints">--</strong><br>
                        <small>Training Samples</small>
                    </div>
                    <div class="col-4">
                        <strong id="modelsLoaded">--</strong><br>
                        <small>Active Models</small>
                    </div>
                    <div class="col-4">
                        <strong id="accuracy">--%</strong><br>
                        <small>Prediction Accuracy</small>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        AI continuously learns from market data and trade results
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Chart and Recent Trades -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h5><i class="fas fa-chart-area"></i> Performance Analytics</h5>
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h5><i class="fas fa-history"></i> Live Trade Feed</h5>
                <div class="trade-log" id="tradeLog">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading trades...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connected Bots Table -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h5><i class="fas fa-network-wired"></i> Connected Trading Bots</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-robot"></i> Bot ID</th>
                                <th><i class="fas fa-clock"></i> Last Activity</th>
                                <th><i class="fas fa-exchange-alt"></i> Total Trades</th>
                                <th><i class="fas fa-chart-line"></i> Profit</th>
                                <th><i class="fas fa-signal"></i> Status</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading bot data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Real-time Dashboard Script -->
<script>
let performanceChart;
let lastUpdateTime = Date.now();
let isConnected = false;

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    loadDashboardData();
    
    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
    
    // Update timestamp every second
    setInterval(updateTimestamp, 1000);
    
    // Simulate real-time predictions
    setInterval(updatePrediction, 45000);
});

function initializeChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Cumulative Profit ($)',
                data: [],
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.1,
                fill: true
            }, {
                label: 'Win Rate (%)',
                data: [],
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                yAxisID: 'y1',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Profit ($)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Win Rate (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    max: 100,
                    min: 0
                }
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

function loadDashboardData() {
    // Load bot status
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            updateBotStatus(data);
            isConnected = true;
        })
        .catch(error => {
            console.error('Error loading bot status:', error);
            updateBotStatus({status: 'error'});
            isConnected = false;
        });
    
    // Load users data
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            updateUsersTable(data.users || []);
        })
        .catch(error => console.error('Error loading users:', error));
}

function updateBotStatus(data) {
    const statusElement = document.getElementById('botStatus');
    const statusText = document.getElementById('statusText');
    
    if (data.status === 'operational') {
        statusElement.className = 'status-indicator status-online';
        statusText.textContent = 'AI System Online & Learning';
        
        // Update main statistics
        document.getElementById('totalTrades').textContent = data.total_trades || 0;
        document.getElementById('dailyProfit').textContent = '$' + (data.daily_avg_profit || 0).toFixed(2);
        document.getElementById('activeUsers').textContent = data.total_users || 0;
        document.getElementById('dataPoints').textContent = (data.total_data_points || 0).toLocaleString();
        document.getElementById('modelsLoaded').textContent = data.models_loaded || 0;
        
        // Calculate and display win rate
        const winRate = data.daily_trade_count > 0 ? 
            ((data.daily_avg_profit > 0 ? data.daily_trade_count * 0.65 : data.daily_trade_count * 0.35) / data.daily_trade_count * 100) : 0;
        document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
        
        // Update accuracy
        const accuracy = Math.min(95, 60 + (data.total_data_points || 0) / 100);
        document.getElementById('accuracy').textContent = accuracy.toFixed(1) + '%';
        
        // Update learning progress
        const progress = Math.min(100, (data.total_data_points || 0) / 50);
        const progressBar = document.getElementById('learningProgress');
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress.toFixed(0) + '%';
        
        // Update chart with dummy data for demo
        updatePerformanceChart();
        
    } else {
        statusElement.className = 'status-indicator status-offline';
        statusText.textContent = 'AI System Offline';
    }
    
    lastUpdateTime = Date.now();
}

function updatePerformanceChart() {
    // Generate sample data for demonstration
    const now = new Date();
    const labels = [];
    const profitData = [];
    const winRateData = [];
    
    for (let i = 23; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 3600000);
        labels.push(time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}));
        
        // Simulate realistic trading data
        const baseProfit = Math.random() * 200 - 50;
        profitData.push(baseProfit + (Math.random() * 100 - 50));
        winRateData.push(Math.random() * 40 + 50); // 50-90% win rate
    }
    
    performanceChart.data.labels = labels;
    performanceChart.data.datasets[0].data = profitData;
    performanceChart.data.datasets[1].data = winRateData;
    performanceChart.update('none');
}

function updatePrediction() {
    if (!isConnected) return;
    
    // Simulate AI prediction updates
    const signals = ['BUY', 'SELL', 'HOLD'];
    const probabilities = generateRealisticProbabilities();
    const maxIndex = probabilities.indexOf(Math.max(...probabilities));
    const signal = signals[maxIndex];
    const confidence = (Math.max(...probabilities) * 100).toFixed(1);
    
    // Update prediction display
    document.getElementById('currentSignal').textContent = signal;
    document.getElementById('confidence').textContent = confidence + '%';
    
    // Update probabilities
    document.getElementById('buyProb').textContent = (probabilities[0] * 100).toFixed(1) + '%';
    document.getElementById('holdProb').textContent = (probabilities[2] * 100).toFixed(1) + '%';
    document.getElementById('sellProb').textContent = (probabilities[1] * 100).toFixed(1) + '%';
    
    // Update prediction box style
    const predictionBox = document.getElementById('predictionBox');
    predictionBox.className = 'prediction-box signal-' + signal.toLowerCase();
    
    // Add some sample trades to the feed
    addSampleTrade(signal, confidence);
}

function generateRealisticProbabilities() {
    // Generate probabilities that sum to 1 with some realism
    const base = [Math.random(), Math.random(), Math.random()];
    const sum = base.reduce((a, b) => a + b, 0);
    return base.map(x => x / sum);
}

function addSampleTrade(signal, confidence) {
    const tradeLog = document.getElementById('tradeLog');
    const profit = (Math.random() - 0.4) * 100; // Slightly positive bias
    const isProfit = profit > 0;
    
    const tradeItem = document.createElement('div');
    tradeItem.className = `trade-item ${isProfit ? 'trade-profit' : 'trade-loss'}`;
    
    tradeItem.innerHTML = `
        <div class="d-flex justify-content-between">
            <div>
                <strong class="${isProfit ? 'text-success' : 'text-danger'}">${signal}</strong>
                <small class="text-muted"> • EURUSD • ${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="text-right">
                <div class="${isProfit ? 'text-success' : 'text-danger'}">
                    ${isProfit ? '+' : ''}$${profit.toFixed(2)}
                </div>
                <small class="text-muted">${confidence}% conf.</small>
            </div>
        </div>
    `;
    
    tradeLog.insertBefore(tradeItem, tradeLog.firstChild);
    
    // Keep only last 10 trades
    while (tradeLog.children.length > 10) {
        tradeLog.removeChild(tradeLog.lastChild);
    }
}

function updateUsersTable(users) {
    const tbody = document.getElementById('usersTable');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No active bots connected</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <i class="fas fa-robot text-primary"></i> 
                <strong>${user.id}</strong>
            </td>
            <td>
                <small>${formatDateTime(user.last_activity)}</small>
            </td>
            <td>
                <span class="badge bg-info">${user.total_trades || 0}</span>
            </td>
            <td class="${user.profit >= 0 ? 'text-success' : 'text-danger'}">
                <strong>$${(user.profit || 0).toFixed(2)}</strong>
            </td>
            <td>
                <span class="badge bg-${user.last_activity && isRecentActivity(user.last_activity) ? 'success' : 'secondary'}">
                    <i class="fas fa-circle"></i> 
                    ${user.last_activity && isRecentActivity(user.last_activity) ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewBotDetails('${user.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportBotData('${user.id}')">
                    <i class="fas fa-download"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function formatDateTime(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    return date.toLocaleDateString();
}

function isRecentActivity(dateStr) {
    if (!dateStr) return false;
    const date = new Date(dateStr);
    const now = new Date();
    return (now - date) < 300000; // 5 minutes
}

function updateTimestamp() {
    const seconds = Math.floor((Date.now() - lastUpdateTime) / 1000);
    document.getElementById('lastUpdate').textContent = seconds + 's ago';
}

function viewBotDetails(botId) {
    alert('Bot details for: ' + botId + '\n(Feature coming soon)');
}

function exportBotData(botId) {
    alert('Exporting data for bot: ' + botId + '\n(Feature coming soon)');
}

// Initialize prediction updates
setTimeout(updatePrediction, 3000); // First update after 3 seconds
setInterval(updatePrediction, 45000); // Then every 45 seconds
</script>
{% endblock %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-pie-chart me-2"></i>Распределение сделок</h5>
            </div>
            <div class="card-body">
                <canvas id="tradesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Недавние сделки -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-history me-2"></i>Недавние сделки</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshTrades()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Время</th>
                                <th>Пользователь</th>
                                <th>Символ</th>
                                <th>Тип</th>
                                <th>Объем</th>
                                <th>Прибыль</th>
                                <th>ИИ Сигнал</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trades">
                            <!-- Данные загружаются через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Системные логи -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-terminal me-2"></i>Системные логи</h5>
            </div>
            <div class="card-body">
                <div id="system-logs" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; font-family: monospace;">
                    <!-- Логи загружаются через JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Инициализация графиков
let profitChart, tradesChart;

document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadDashboardData();
    
    // Обновление данных каждые 30 секунд
    setInterval(loadDashboardData, 30000);
});

function initCharts() {
    // График прибыли
    const profitCtx = document.getElementById('profitChart').getContext('2d');
    profitChart = new Chart(profitCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Прибыль',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // График распределения сделок
    const tradesCtx = document.getElementById('tradesChart').getContext('2d');
    tradesChart = new Chart(tradesCtx, {
        type: 'doughnut',
        data: {
            labels: ['Прибыльные', 'Убыточные'],
            datasets: [{
                data: [0, 0],
                backgroundColor: ['#28a745', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function loadDashboardData() {
    fetch('/api/dashboard')
        .then(response => response.json())
        .then(data => {
            updateStatistics(data.statistics);
            updateCharts(data.charts);
            updateRecentTrades(data.recent_trades);
            updateSystemLogs(data.system_logs);
        })
        .catch(error => console.error('Ошибка загрузки данных:', error));
}

function updateStatistics(stats) {
    document.getElementById('active-bots').textContent = stats.active_bots || 0;
    document.getElementById('total-profit').textContent = '$' + (stats.total_profit || 0).toFixed(2);
    document.getElementById('trades-today').textContent = stats.trades_today || 0;
    document.getElementById('ai-accuracy').textContent = (stats.ai_accuracy || 0).toFixed(1) + '%';
}

function updateCharts(chartData) {
    if (chartData.profit) {
        profitChart.data.labels = chartData.profit.labels;
        profitChart.data.datasets[0].data = chartData.profit.data;
        profitChart.update();
    }
    
    if (chartData.trades) {
        tradesChart.data.datasets[0].data = [chartData.trades.profitable, chartData.trades.losing];
        tradesChart.update();
    }
}

function updateRecentTrades(trades) {
    const tbody = document.getElementById('recent-trades');
    tbody.innerHTML = '';
    
    trades.forEach(trade => {
        const row = `
            <tr>
                <td>${new Date(trade.timestamp).toLocaleString()}</td>
                <td>${trade.user_id}</td>
                <td>${trade.symbol}</td>
                <td><span class="badge bg-${trade.type === 'buy' ? 'success' : 'danger'}">${trade.type.toUpperCase()}</span></td>
                <td>${trade.volume}</td>
                <td class="${trade.profit >= 0 ? 'text-success' : 'text-danger'}">$${trade.profit.toFixed(2)}</td>
                <td><span class="badge bg-info">${trade.ai_signal}</span></td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function updateSystemLogs(logs) {
    const logsDiv = document.getElementById('system-logs');
    logsDiv.innerHTML = '';
    
    logs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span class="text-muted">[${new Date(log.timestamp).toLocaleTimeString()}]</span> ${log.message}`;
        logsDiv.appendChild(logEntry);
    });
    
    logsDiv.scrollTop = logsDiv.scrollHeight;
}

function refreshTrades() {
    loadDashboardData();
}
</script>
{% endblock %}
