{% extends "base.html" %}

{% block content %}
<div class="row mt-3">
    <div class="col-12">
        <h1><i class="fas fa-users me-2"></i>Управление пользователями</h1>
        <p class="text-muted">Мониторинг активности пользователей торгового бота</p>
    </div>
</div>

<!-- Фильтры -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-filter me-2"></i>Фильтры</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="dateRange" class="form-label">Период</label>
                        <select class="form-select" id="dateRange" onchange="filterUsers()">
                            <option value="today">Сегодня</option>
                            <option value="week" selected>Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="all">Все время</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="statusFilter" class="form-label">Статус</label>
                        <select class="form-select" id="statusFilter" onchange="filterUsers()">
                            <option value="all">Все</option>
                            <option value="active">Активные</option>
                            <option value="inactive">Неактивные</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>Общая статистика</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h4 id="total-users" class="text-primary">0</h4>
                        <small>Всего пользователей</small>
                    </div>
                    <div class="col-4">
                        <h4 id="active-users" class="text-success">0</h4>
                        <small>Активных</small>
                    </div>
                    <div class="col-4">
                        <h4 id="total-user-profit" class="text-info">$0</h4>
                        <small>Общая прибыль</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Таблица пользователей -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table me-2"></i>Список пользователей</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID пользователя</th>
                                <th>Статус</th>
                                <th>Последняя активность</th>
                                <th>Сделок</th>
                                <th>Прибыль</th>
                                <th>Точность ИИ</th>
                                <th>Риск-уровень</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Данные загружаются через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модал с деталями пользователя -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="user-details-content">
                <!-- Контент загружается динамически -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    
    // Обновление данных каждую минуту
    setInterval(loadUsers, 60000);
});

function loadUsers() {
    const dateRange = document.getElementById('dateRange').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    fetch(`/api/users?period=${dateRange}&status=${statusFilter}`)
        .then(response => response.json())
        .then(data => {
            updateUserStats(data.stats);
            updateUsersTable(data.users);
        })
        .catch(error => console.error('Ошибка загрузки пользователей:', error));
}

function updateUserStats(stats) {
    document.getElementById('total-users').textContent = stats.total || 0;
    document.getElementById('active-users').textContent = stats.active || 0;
    document.getElementById('total-user-profit').textContent = '$' + (stats.total_profit || 0).toFixed(2);
}

function updateUsersTable(users) {
    const tbody = document.getElementById('users-table');
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const lastActivity = new Date(user.last_activity);
        const isActive = (new Date() - lastActivity) < 5 * 60 * 1000; // активен если был онлайн менее 5 минут назад
        
        const row = `
            <tr>
                <td>
                    <strong>${user.user_id}</strong>
                    <br><small class="text-muted">${user.account_info || 'N/A'}</small>
                </td>
                <td>
                    <span class="badge bg-${isActive ? 'success' : 'secondary'}">
                        ${isActive ? 'Онлайн' : 'Офлайн'}
                    </span>
                </td>
                <td>${lastActivity.toLocaleString()}</td>
                <td>
                    <span class="badge bg-info">${user.total_trades || 0}</span>
                    <br><small class="text-success">${user.winning_trades || 0} побед</small>
                </td>
                <td class="${user.total_profit >= 0 ? 'text-success' : 'text-danger'}">
                    $${(user.total_profit || 0).toFixed(2)}
                    <br><small>PnL: ${((user.total_profit || 0) / Math.max(user.total_trades || 1, 1)).toFixed(2)}</small>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-warning" style="width: ${user.ai_accuracy || 0}%">
                            ${(user.ai_accuracy || 0).toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${getRiskColor(user.risk_level)}">
                        ${user.risk_level || 'Средний'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showUserDetails('${user.user_id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function getRiskColor(riskLevel) {
    switch(riskLevel) {
        case 'Низкий': return 'success';
        case 'Высокий': return 'danger';
        default: return 'warning';
    }
}

function showUserDetails(userId) {
    fetch(`/api/users/${userId}/details`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основная информация</h6>
                        <table class="table table-sm">
                            <tr><td>ID:</td><td>${data.user_id}</td></tr>
                            <tr><td>Регистрация:</td><td>${new Date(data.registration_date).toLocaleString()}</td></tr>
                            <tr><td>Баланс:</td><td>$${data.balance.toFixed(2)}</td></tr>
                            <tr><td>Эквити:</td><td>$${data.equity.toFixed(2)}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Торговая статистика</h6>
                        <table class="table table-sm">
                            <tr><td>Всего сделок:</td><td>${data.total_trades}</td></tr>
                            <tr><td>Прибыльных:</td><td class="text-success">${data.winning_trades}</td></tr>
                            <tr><td>Убыточных:</td><td class="text-danger">${data.losing_trades}</td></tr>
                            <tr><td>Win Rate:</td><td>${data.win_rate.toFixed(1)}%</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>График прибыли</h6>
                        <canvas id="userProfitChart" height="100"></canvas>
                    </div>
                </div>
            `;
            
            document.getElementById('user-details-content').innerHTML = content;
            
            // Создаем график для пользователя
            const ctx = document.getElementById('userProfitChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.profit_history.labels,
                    datasets: [{
                        label: 'Прибыль',
                        data: data.profit_history.data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
        })
        .catch(error => console.error('Ошибка загрузки деталей пользователя:', error));
}

function filterUsers() {
    loadUsers();
}

function refreshUsers() {
    loadUsers();
}
</script>
{% endblock %}
